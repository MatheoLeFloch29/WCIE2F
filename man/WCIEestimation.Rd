% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/wcieestimation.R
\name{WCIEestimation}
\alias{WCIEestimation}
\title{Estimation of the Weighted Cumulative Effect with Two-Level}
\usage{
WCIEestimation(
  mexpo,
  var.time,
  timerange,
  step,
  weightbasis,
  knots,
  data,
  reg.type,
  model
)
}
\arguments{
\item{mexpo}{An object of class \code{hlme} from the \code{lcmm} package, used to model the exposure process.
The object must be created using the \code{hlme} function with specific arguments provided.
The fixed effects formula and the random effects formula must be specified. The \code{subject} argument
must indicate the subject ID, and the dataset must be provided via the \code{data} argument.
It is essential to include \code{returnData = TRUE} in the function call to ensure that the internal data can be accessed.}

\item{var.time}{character indicating the name of the time variable
in the model \code{mexpo}.}

\item{timerange}{Numeric vector of length 2
indicating the desired time window for exposure (min, max).}

\item{step}{Step between two consecutive time points in the time window indicating in \code{timerange}.}

\item{weightbasis}{Type of temporal weighting function used to estimate the Weighted Cumulative Indirect Effects (WCIE).
This specifies the functional form used to model the influence of past exposures over time.
Currently, the following options are available: \code{"NS"} for natural splines (implemented),
\code{"BS"} for B-splines (to be developed), and \code{"PS"} for P-splines (to be developed).}

\item{knots}{Number of internal knots for the splines (used only for splines temporal weighting function).}

\item{data}{A data frame containing the variables specified in the outcome model
\code{model} including the outcome variable. This dataset will be used to estimate the
outcome model, and the WCIE variables calculated previously will be added to this
dataset prior to model fitting.}

\item{reg.type}{Type of outcome model: \code{"logistic"}, \code{"cox"}, ...}

\item{model}{two-sided linear formula object for the outcome model. The response outcome is on
the left of ~ and the covariates are separated by + on the right of ~. To include the effect of past exposure,
you must explicitly add \code{WCIE} (or interaction terms such as \code{WCIE:sex}) to the formula.
For example, \code{Y ~ WCIE + age + sex} or \code{Y ~ WCIE:sex + age} are valid formulas.}
}
\value{
A list containing:
  \item{model}{outcome model object}
  \item{data_expo}{Intermediate data set with individual predictions.}
  \item{mexpo}{Exposure model \code{hlme} object provided at the beginning.}
  \item{data_outcome}{Data set used to fit the outcome model.}
  \item{call}{The matched call for the outcome model.}
  \item{splines.quantiles}{The internal quantiles used for the natural splines,
  which define the time-weighting function.}
  \item{boundary.quantiles}{The lower and upper bounds of the natural splines
  (5th and 95th percentiles), used to define the limits of the time-weighting function.}
  \item{AIC}{AIC criteria of the outcome model.}
  \item{loglike}{log-likelihood of the outcome model.}
}
\description{
Cette fonction permet d’estimer l’effet de l'histoire d'une exposition sur un
outcome de santé (tel qu’un événement binaire, un temps de survie, ou bien un événement répété),
en utilisant une approche basée sur le WCIE (Weight Cumulative Index of Exposure).
La fonction s’adresse aux données longitudinales où l’exposition varie dans le temps,
et où l'on souhaite modéliser l’effet de cette exposition sur un outcome.


A. Estimation follows the following steps:

(1) Individual prediction of exposure:
Based on the mixed model \code{mexpo}, which must be an object of class \code{hlme},
individual exposure trajectories are predicted over a user-defined time window
(\code{timerange}) and frequency (\code{step}).
The presence or absence of a random intercept is taken into account, but random effects
must be explicitly specified.
The temporal structure (e.g., splines, polynomials) used in the original model is preserved,
but must be directly included in the \code{mexpo} model.

(2) Reconstruction of the exposure history:
A temporal weighting basis is used to construct the WCIE, i.e., time-weighted exposure scores.
Currently, only natural splines (NS) are implemented. The spline knots are automatically
 computed based on time quantiles, according to the number of internal knots (\code{knots})
 specified by the user.

(3) Computation of the WCIE:
The WCIE corresponds to the weighted sum of the products between time spline basis functions
 and predicted exposure values.
Each spline generates a separate WCIE component (e.g., WCIE1, WCIE2, ...).

(4) Outcome modeling:
A model is then fitted to the outcome, incorporating the WCIE components as explanatory
variables.
Two types of models are currently available via the \code{reg.type} argument:
- "logistic": logistic regression (GLM model)
- "cox": Cox proportional hazards model (under development)
The final formula is automatically reconstructed based on the original model, replacing
the exposure term with the sum of WCIE components.

The function output includes:
- the fitted outcome model (glm),
- the temporal predictions (Ypred) and random effects,
- the time quantiles used for splines,
- the final formula used in the outcome model.


\strong{B. USAGE PRECAUTIONS:}

(1) The estimation of WCIE relies on the quality of the exposure model provided in \code{mexpo}.
Since this model is used to simulate exposure histories, incorrect specification of fixed
or random effects may bias the WCIE estimates. It is strongly recommended to use natural
splines (\code{NS}) for the time structure and ensure that returndata = TRUE is specified in the \code{hlme}
object.

(2) The weighting function used to estimate the WCIE over time can
lead to instability or overfitting if the number of \code{knots} is too high or if the time window
(\code{timerange}) is poorly chosen. Users should inspect the shape of the weight function and
consider simplifying it if convergence issues or unreasonable effects are detected.

(3) Convergence problems can occur in the outcome model if the WCIE variables are highly
collinear, especially when using a fine time grid (\code{step}) or too many \code{knots}. If the model
fails to converge, consider reducing the number of time points or the complexity of the
spline basis.
}
\references{
Maud Wagner et al. “Time-varying associations between an exposure history and a subsequent health
outcome : a landmark approach to identify critical windows”. In : BMC Med Res Methodol (2021).
doi : 10.1186/s12874-021-01403-w
}
\seealso{
\code{\link{WCIE2F}}
}
\author{
Encore un giga beau gosse
}
